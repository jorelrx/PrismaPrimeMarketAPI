#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ§ª Executando testes locais antes do push..."

# Inicia PostgreSQL de testes
echo "â³ Iniciando PostgreSQL para testes..."
docker-compose -f docker-compose.test.yml up -d
sleep 5

echo "â³ Buildando o projeto..."

# Build do projeto
dotnet build --configuration Release --no-restore

if [ $? -ne 0 ]; then
  echo "âŒ Build falhou! Push bloqueado."
  docker-compose -f docker-compose.test.yml down
  exit 1
fi

echo "âœ… Build concluÃ­do com sucesso!"
echo "â³ Executando testes..."

# Executa os testes
dotnet test --no-build --configuration Release --verbosity normal

TEST_RESULT=$?

# Para PostgreSQL de testes
echo "â³ Parando PostgreSQL de testes..."
docker-compose -f docker-compose.test.yml down

if [ $TEST_RESULT -ne 0 ]; then
  echo "âŒ Testes falharam! Push bloqueado."
  echo "ğŸ’¡ Corrija os testes antes de fazer push."
  exit 1
fi

echo "âœ… Todos os testes passaram!"
echo "ğŸš€ Push liberado!"
